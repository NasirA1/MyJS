#! /usr/bin/env node

const express = require('express');
const bodyParser = require('body-parser');
const path = require('path');
const NodeCouchDb = require('node-couchdb');

const couch = new NodeCouchDb({
  auth: {
    user: 'scott',
    password: 'tiger'
  }
});

const app = express();
const dbName = 'customers';
const viewUrl = '_design/customers/_view/all_customers';


//Configure
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: false}));


class DAL {

  GetAllCustomers() {
    return new Promise( (resolve, reject) => {
      couch.get(dbName, viewUrl).then(
        function(data, headers, status) {
          let xs = data.data.rows.map( x => { return x.value } );
          console.log(JSON.stringify(xs, null, 2));
          resolve(xs);
        },
        function(err) {
          reject(err);
        });
    });
  }

}


var db = new DAL();


function onGet(req, res) {
  db.GetAllCustomers()
    .then( xs => res.render('index', { customers: xs}) )
    .catch( err => res.send(err) );
}


function onAddCustomer(req, res) {
  const name = req.body.name;
  const email = req.body.email;

  couch.uniqid().then( function(ids){
    const id = ids[0];
    couch.insert('customers', {
      _id: id,
      name: name,
      email: email
    }).then(
      function(data, headers, status){
        res.redirect('/');
      },
      function(err) {
        res.send(err);
      }
    );
  });
}


function onDeleteCustomer(req, res) {
  const id = req.params.id;
  const rev = req.body.rev;

  couch.del(dbName, id, rev).then(
    function(data, header, status){
      res.redirect('/');
    },
    function(err) {
      res.send(err);
  });

}


app.get('/', onGet);
app.post('/customer/add', onAddCustomer);
app.post('/customer/delete/:id', onDeleteCustomer);
app.listen(8000, ()=> { console.log('Listening on 8000...'); });
couch.listDatabases().then( (dbs) => console.log(dbs) );
